!function(){"use strict";function a(t){var e=t;return{get:function(){return e},set:function(t){e=t}}}function t(){}function e(){return s}var n=tinymce.util.Tools.resolve("tinymce.PluginManager"),r=tinymce.util.Tools.resolve("tinymce.util.Tools"),i=function(t){return function(){return t}},u=i(!1),c=i(!0),s={fold:function(t,e){return t()},is:u,isSome:u,isNone:c,getOr:l,getOrThunk:f,getOrDie:function(t){throw new Error(t||"error: getOrDie called on none.")},getOrNull:i(null),getOrUndefined:i(void 0),or:l,orThunk:f,map:e,each:t,bind:e,exists:u,forall:c,filter:e,equals:o,equals_:o,toArray:function(){return[]},toString:i("none()")};function o(t){return t.isNone()}function f(t){return t()}function l(t){return t}var d,m=function(n){function t(){return r}function e(t){return t(n)}var o=i(n),r={fold:function(t,e){return e(n)},is:function(t){return n===t},isSome:c,isNone:u,getOr:o,getOrThunk:o,getOrDie:o,getOrNull:o,getOrUndefined:o,or:t,orThunk:t,map:function(t){return m(t(n))},each:function(t){t(n)},bind:e,exists:e,forall:e,filter:function(t){return t(n)?r:s},toArray:function(){return[n]},toString:function(){return"some("+n+")"},equals:function(t){return t.is(n)},equals_:function(t,e){return t.fold(u,function(t){return e(n,t)})}};return r},h={some:m,none:e,from:function(t){return null==t?s:m(t)}},g=(d="function",function(t){return typeof t===d});function p(t,e){return w(document.createElement("canvas"),t,e)}function v(t){var e=p(t.width,t.height);return y(e).drawImage(t,0,0),e}function y(t){return t.getContext("2d")}function w(t,e,n){return t.width=e,t.height=n,t}var b,I,T,_=window.Promise?window.Promise:(b=window,I=R.immediateFn||"function"==typeof b.setImmediate&&b.setImmediate||function(t){setTimeout(t,1)},T=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},R.prototype.catch=function(t){return this.then(null,t)},R.prototype.then=function(n,o){var r=this;return new R(function(t,e){A.call(r,new L(n,o,t,e))})},R.all=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var a=Array.prototype.slice.call(1===t.length&&T(t[0])?t[0]:t);return new R(function(r,i){if(0===a.length)return r([]);var u=a.length;for(var t=0;t<a.length;t++)!function e(n,t){try{if(t&&("object"==typeof t||"function"==typeof t)){var o=t.then;if("function"==typeof o)return void o.call(t,function(t){e(n,t)},i)}a[n]=t,0==--u&&r(a)}catch(t){i(t)}}(t,a[t])})},R.resolve=function(e){return e&&"object"==typeof e&&e.constructor===R?e:new R(function(t){t(e)})},R.reject=function(n){return new R(function(t,e){e(n)})},R.race=function(r){return new R(function(t,e){for(var n=0,o=r;n<o.length;n++){o[n].then(t,e)}})},R);function R(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],k(t,U(x,this),U(E,this))}function U(t,e){return function(){return t.apply(e,arguments)}}function A(n){var o=this;null!==this._state?I(function(){var t,e=o._state?n.onFulfilled:n.onRejected;if(null!==e){try{t=e(o._value)}catch(t){return void n.reject(t)}n.resolve(t)}else(o._state?n.resolve:n.reject)(o._value)}):this._deferreds.push(n)}function x(t){try{if(t===this)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var e=t.then;if("function"==typeof e)return void k(U(e,t),U(x,this),U(E,this))}this._state=!0,this._value=t,j.call(this)}catch(t){E.call(this,t)}}function E(t){this._state=!1,this._value=t,j.call(this)}function j(){for(var t=0,e=this._deferreds;t<e.length;t++){var n=e[t];A.call(this,n)}this._deferreds=[]}function L(t,e,n,o){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.resolve=n,this.reject=o}function k(t,e,n){var o=!1;try{t(function(t){o||(o=!0,e(t))},function(t){o||(o=!0,n(t))})}catch(t){if(o)return;o=!0,n(t)}}function C(t){var o,t=t.src;return 0===t.indexOf("data:")?P(t):(o=t,new _(function(t,n){var e=new XMLHttpRequest;e.open("GET",o,!0),e.responseType="blob",e.onload=function(){200===this.status&&t(this.response)},e.onerror=function(){var t,e=this;n(0===this.status?((t=new Error("No access to download image")).code=18,t.name="SecurityError",t):new Error("Error "+e.status+" downloading image"))},e.send()}))}function O(a){return new _(function(t,e){var n=URL.createObjectURL(a),o=new Image,r=function(){o.removeEventListener("load",i),o.removeEventListener("error",u)};function i(){r(),t(o)}function u(){r(),e("Unable to load data of type "+a.type+": "+n)}o.addEventListener("load",i),o.addEventListener("error",u),o.src=n,o.complete&&i()})}function P(n){return new _(function(t,e){(function(t){var e=t.split(",");if(!(t=/data:([^;]+)/.exec(e[0])))return h.none();for(var t=t[1],e=e[1],n=atob(e),o=n.length,r=Math.ceil(o/1024),i=new Array(r),u=0;u<r;++u){for(var a=1024*u,c=Math.min(1024+a,o),s=new Array(c-a),f=a,l=0;f<c;++l,++f)s[l]=n[f].charCodeAt(0);i[u]=new Uint8Array(s)}return h.some(new Blob(i,{type:t}))})(n).fold(function(){e("uri is not base64: "+n)},t)})}function S(t,o,r){return o=o||"image/png",g(HTMLCanvasElement.prototype.toBlob)?new _(function(e,n){t.toBlob(function(t){t?e(t):n()},o,r)}):P(t.toDataURL(o,r))}function M(t){return O(t).then(function(t){e=t,URL.revokeObjectURL(e.src);var e,e=p((e=t).naturalWidth||e.width,(e=t).naturalHeight||e.height);return y(e).drawImage(t,0,0),e})}function B(t,e){return function(t,e,n){for(var o=0,r=t.length;o<r;o++){var i=t[o];if(e(i,o))return h.some(i);if(n(i,o))break}return h.none()}(t,e,u)}var N=O,D=C;function F(t,e,n){var o=e.type;function r(o,r){return t.then(function(t){return n=r,e=(e=o)||"image/png",t.toDataURL(e,n);var e,n})}return{getType:i(o),toBlob:function(){return _.resolve(e)},toDataURL:i(n),toBase64:function(){return n.split(",")[1]},toAdjustedBlob:function(e,n){return t.then(function(t){return S(t,e,n)})},toAdjustedDataURL:r,toAdjustedBase64:function(t,e){return r(t,e).then(function(t){return t.split(",")[1]})},toCanvas:function(){return t.then(v)}}}function H(e){return n=e,new _(function(t){var e=new FileReader;e.onloadend=function(){t(e.result)},e.readAsDataURL(n)}).then(function(t){return F(M(e),e,t)});var n}function q(e,t){return S(e,t).then(function(t){return F(_.resolve(e),t,e.toDataURL())})}function z(e,n){return e.toCanvas().then(function(t){return function(t,e,n){var o=p(t.width,t.height),r=y(o),i=0,u=0;90!==(n=n<0?360+n:n)&&270!==n||w(o,o.height,o.width);90!==n&&180!==n||(i=o.width);270!==n&&180!==n||(u=o.height);return r.translate(i,u),r.rotate(n*Math.PI/180),r.drawImage(t,0,0),q(o,e)}(t,e.getType(),n)})}function $(e,n){return e.toCanvas().then(function(t){return function(t,e,n){var o=p(t.width,t.height),r=y(o);"v"===n?(r.scale(1,-1),r.drawImage(t,0,-o.height)):(r.scale(-1,1),r.drawImage(t,-o.width,0));return q(o,e)}(t,e.getType(),n)})}function G(e,o,r){return void 0===r&&(r=!1),new _(function(t){var n=new XMLHttpRequest;n.onreadystatechange=function(){4===n.readyState&&t({status:n.status,blob:n.response})},n.open("GET",e,!0),n.withCredentials=r,function(t,e){for(var n=ot(t),o=0,r=n.length;o<r;o++){var i=n[o];e(t[i],i)}}(o,function(t,e){n.setRequestHeader(e,t)}),n.responseType="blob",n.send()})}function J(t){var e,t=(e=t,"ImageProxy HTTP error: "+B(rt,function(t){return e===t.code}).fold(i("Unknown ImageProxy error"),function(t){return t.message}));return _.reject(t)}function K(e){return B(it,function(t){return t.type===e}).fold(i("Unknown service error"),function(t){return t.message})}function V(t){return"ImageProxy Service error: "+function(t){try{return h.some(JSON.parse(t))}catch(t){return h.none()}}(t).bind(function(t){return e=function(t,e){return null==t?void 0:t[e]},n=t,function(t,e){for(var n=0,o=t.length;n<o;n++){e(t[n],n)}}(t=["error","type"],function(t){n=e(n,t)}),t=n,h.from(t).map(K);var e,n}).getOr("Invalid JSON in service error message")}function W(t){return o=t,new _(function(t,e){var n=new FileReader;n.onload=function(){t(n.result)},n.onerror=function(t){e(t)},n.readAsText(o)}).then(function(t){t=V(t);return _.reject(t)});var o}function X(t){return t<200||300<=t}function Q(t,e){var n,o={"Content-Type":"application/json;charset=UTF-8","tiny-api-key":e};return G((n=e,t=-1===(e=t).indexOf("?")?"?":"&",/[?&]apiKey=/.test(e)?e:e+t+"apiKey="+encodeURIComponent(n)),o).then(function(t){return X(t.status)?(e=t.status,n=t.blob,o=e,"application/json"!==(null==(r=n)?void 0:r.type)||400!==o&&403!==o&&404!==o&&500!==o?J(e):W(n)):_.resolve(t.blob);var e,n,o,r})}function Y(t,e,n){return void 0===n&&(n=!1),e?Q(t,e):G(t,{},n).then(function(t){return X(t.status)?J(t.status):_.resolve(t.blob)})}function Z(t,e){return n=function(t){return function(t,e){t=t.dom;if(1!==t.nodeType)return!1;if(void 0!==t.matches)return t.matches(e);if(void 0!==t.msMatchesSelector)return t.msMatchesSelector(e);if(void 0!==t.webkitMatchesSelector)return t.webkitMatchesSelector(e);if(void 0!==t.mozMatchesSelector)return t.mozMatchesSelector(e);throw new Error("Browser lacks native selectors")}(t,e)},B(t.dom.childNodes,function(t){return n(ct.fromDom(t))}).map(ct.fromDom);var n}function tt(t){return t.getParam("imagetools_proxy")}var et=$,nt=z,ot=Object.keys,rt=[{code:404,message:"Could not find Image Proxy"},{code:403,message:"Rejected request"},{code:0,message:"Incorrect Image Proxy URL"}],it=[{type:"not_found",message:"Failed to load image."},{type:"key_missing",message:"The request did not include an api key."},{type:"key_not_found",message:"The provided api key could not be found."},{type:"domain_not_trusted",message:"The api key is not valid for the request origins."}],ut=H,at=function(t){if(null==t)throw new Error("Node cannot be null or undefined");return{dom:t}},ct={fromHtml:function(t,e){e=(e||document).createElement("div");if(e.innerHTML=t,!e.hasChildNodes()||1<e.childNodes.length)throw console.error("HTML does not have a single root node",t),new Error("HTML must have a single root node");return at(e.childNodes[0])},fromTag:function(t,e){t=(e||document).createElement(t);return at(t)},fromText:function(t,e){t=(e||document).createTextNode(t);return at(t)},fromDom:at,fromPoint:function(t,e,n){return h.from(t.dom.elementFromPoint(e,n)).map(at)}},st=("undefined"!=typeof window||Function("return this;")(),tinymce.util.Tools.resolve("tinymce.util.Delay")),ft=tinymce.util.Tools.resolve("tinymce.util.Promise"),lt=tinymce.util.Tools.resolve("tinymce.util.URI");function dt(t){var e,n;function o(t){return/^[0-9\.]+px$/.test(t)}return e=t.style.width,n=t.style.height,e||n?o(e)&&o(n)?{w:parseInt(e,10),h:parseInt(n,10)}:null:(e=t.width,n=t.height,e&&n?{w:parseInt(e,10),h:parseInt(n,10)}:null)}function mt(t){return{w:t.naturalWidth,h:t.naturalHeight}}function ht(t){return Z(ct.fromDom(t),"img")}function gt(t,e){return t.dom.is(e,"figure")}function pt(n,t){function e(t){return e=t,n.dom.is(e,"img:not([data-mce-object],[data-mce-placeholder])")&&(Ot(n,t)||Pt(n,t)||tt(n));var e}return gt(n,t)?ht(t).map(function(t){return e(t.dom)?h.some(t.dom):h.none()}):e(t)?h.some(t):h.none()}function vt(t,e){t.notificationManager.open({text:e,type:"error"})}function yt(t){var e=t.selection.getNode();return gt(t,e)?ht(e):h.some(ct.fromDom(e))}function wt(t,e){if(Pt(t,e))return Y(e.src,null,(n=t,o=e,-1!==r.inArray(n.getParam("imagetools_credentials_hosts",[],"string[]"),new lt(o.src).host)));var n;if(Ot(t,e))return D(e);var o=tt(t),e=o+(-1===o.indexOf("?")?"?":"&")+"url="+encodeURIComponent(e.src),t=(t=t).getParam("api_key",t.getParam("imagetools_api_key","","string"),"string");return Y(e,t,!1)}function bt(t,e){return n=t,h.from(n.getParam("imagetools_fetch_image",null,"function")).fold(function(){return wt(t,e)},function(t){return t(e)});var n}function It(t,e){var n=t.editorUpload.blobCache.getByUri(e.src);return n?ft.resolve(n.blob()):bt(t,e)}function Tt(t){st.clearTimeout(t.get())}function _t(i,u,a,c,s,f){return u.toBlob().then(function(t){var e,n,o=i.editorUpload.blobCache,r=s.src;return i.getParam("images_reuse_filename",!1,"boolean")&&(e=(n=o.getByUri(r))?(r=n.uri(),n.name()):function(t,e){e=e.match(/\/([^\/\?]+)?\.(?:jpeg|jpg|png|gif)(?:\?|$)/i);return e?t.dom.encode(e[1]):null}(i,r)),n=o.create({id:"imagetools"+Ct++,blob:t,base64:u.toBase64(),uri:r,name:e}),o.add(n),i.undoManager.transact(function(){i.$(s).on("load",function t(){var e,n,o;i.$(s).off("load",t),i.nodeChanged(),a?i.editorUpload.uploadImagesAuto():(Tt(c),e=i,n=c,o=st.setEditorTimeout(e,function(){e.editorUpload.uploadImagesAuto()},e.getParam("images_upload_timeout",3e4,"number")),n.set(o))}),f&&i.$(s).attr({width:f.w,height:f.h}),i.$(s).attr({src:n.blobUri()}).removeAttr("data-mce-src")}),n})}function Rt(n,o,t,r){return function(){return yt(n).fold(function(){vt(n,"Could not find selected image")},function(e){return n._scanForImages().then(function(){return It(n,e.dom)}).then(ut).then(t).then(function(t){return _t(n,t,!1,o,e.dom,r)},function(t){vt(n,t)})})}}function Ut(e,n,o){return function(){var t=yt(e).fold(function(){return null},function(t){t=dt(t.dom);return t?{w:t.h,h:t.w}:null});return Rt(e,n,function(t){return nt(t,o)},t)()}}function At(t,e,n){return function(){return Rt(t,e,function(t){return et(t,n)})()}}function xt(e,n,i,u,a){return N(a).then(function(t){var e,n,o,r=mt(t);return u.w===r.w&&u.h===r.h||dt(i)&&(e=i,(n=r)&&(o=e.style.width,r=e.style.height,(o||r)&&(e.style.width=n.w+"px",e.style.height=n.h+"px",e.removeAttribute("data-mce-style")),o=e.width,r=e.height,(o||r)&&(e.setAttribute("width",n.w),e.setAttribute("height",n.h)))),URL.revokeObjectURL(t.src),a}).then(ut).then(function(t){return _t(e,t,!0,n,i)},function(){})}function Et(t){return{blob:t,url:URL.createObjectURL(t)}}function jt(i,u){return function(){var o=yt(i),r=o.map(function(t){return mt(t.dom)});yt(i).each(function(e){pt(i,e.dom).each(function(t){It(i,e.dom).then(function(t){t=Et(t);i.windowManager.open({title:"Edit Image",size:"large",body:{type:"panel",items:[{type:"imagetools",name:"imagetools",label:"Edit Image",currentState:t}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0,disabled:!0}],onSubmit:function(t){var n=t.getData().imagetools.blob;o.each(function(e){r.each(function(t){xt(i,u,e.dom,t,n)})}),t.close()},onCancel:function(){},onAction:function(t,e){switch(e.name){case"save-state":e.value?t.enable("save"):t.disable("save");break;case"disable":t.disable("save"),t.disable("cancel");break;case"enable":t.enable("cancel")}}})})})})}}function Lt(n,t){var o;r.each({mceImageRotateLeft:Ut(n,t,-90),mceImageRotateRight:Ut(n,t,90),mceImageFlipVertical:At(n,t,"v"),mceImageFlipHorizontal:At(n,t,"h"),mceImageLogoMask:function(){yt(o).map(function(t){return mt(t.dom)});yt(o).each(function(e){pt(o,e.dom).each(function(t){It(o,e.dom).then(function(t){Et(t);o.windowManager.open({title:"Example plugin",body:{type:"panel",items:[{type:"input",name:"title",label:"Title"}]},buttons:[{type:"cancel",text:"Close"},{type:"submit",text:"Save",primary:!0}],onSubmit:function(t){}})})})})},mceEditImage:jt(o=n,t)},function(t,e){n.addCommand(e,t)})}function kt(n){function e(t){return function(){return n.execCommand(t)}}n.ui.registry.addButton("rotateleft",{tooltip:"Rotate counterclockwise",icon:"rotate-left",onAction:e("mceImageRotateLeft")}),n.ui.registry.addButton("rotateright",{tooltip:"Rotate clockwise",icon:"rotate-right",onAction:e("mceImageRotateRight")}),n.ui.registry.addButton("flipv",{tooltip:"Flip vertically",icon:"flip-vertically",onAction:e("mceImageFlipVertical")}),n.ui.registry.addButton("fliph",{tooltip:"Flip horizontally",icon:"flip-horizontally",onAction:e("mceImageFlipHorizontal")}),n.ui.registry.addButton("editimage",{tooltip:"Edit image",icon:"edit-image",onAction:e("mceEditImage"),onSetup:function(e){function t(){yt(n).each(function(t){t=pt(n,t.dom).isNone();e.setDisabled(t)})}return n.on("NodeChange",t),function(){n.off("NodeChange",t)}}}),n.ui.registry.addButton("imageoptions",{tooltip:"Image options",icon:"image",onAction:e("mceImage")}),n.ui.registry.addContextMenu("imagetools",{update:function(t){return pt(n,t).fold(function(){return[]},function(t){return[{text:"Edit image",icon:"edit-image",onAction:e("mceEditImage")}]})}})}var Ct=0,Ot=function(t,e){e=e.src;return 0===e.indexOf("data:")||0===e.indexOf("blob:")||new lt(e).host===t.documentBaseURI.host},Pt=function(t,e){return-1!==r.inArray(t.getParam("imagetools_cors_hosts",[],"string[]"),new lt(e.src).host)};n.add("imagetools",function(t){var e,n,o,r,i=a(0),u=a(null);Lt(t,i),kt(t),(e=t).ui.registry.addContextToolbar("imagetools",{items:e.getParam("imagetools_toolbar","rotateleft rotateright flipv fliph editimage imageoptions"),predicate:function(t){return pt(e,t).isSome()},position:"node",scope:"node"}),o=i,r=u,(n=t).on("NodeChange",function(t){var e=r.get();e&&e.src!==t.element.src&&(Tt(o),n.editorUpload.uploadImagesAuto(),r.set(null)),pt(n,t.element).each(r.set)})})}();